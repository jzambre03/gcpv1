<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>{{ service_name }} - Golden Config AI</title>
  
  <style>
    :root{
      --vz-red:#B91C1C; --med:#D97706; --low:#4B5563; --allowed: #6B7280;
      --ink:#111827; --muted:#6B7280; --bg:#F9FAFB;
      --panel:#FFFFFF; --line:#E5E7EB; --chip:#F3F4F6;
      --shadow:0 4px 6px -1px rgba(0,0,0,.07), 0 2px 4px -2px rgba(0,0,0,.07);
      --success: #10B981; --success-bg: #D1FAE5;
      --warning: #F59E0B; --warning-bg: #FEF3C7;
      --error: #EF4444; --error-bg: #FEE2E2;
      --info: #3B82F6; --info-bg: #DBEAFE;
      --add-bg:#E0F2F1; --add-text:#00796B; --add-inline-bg: #D1FAE5;
      --del-bg:#FFEBEE; --del-text:#C62828; --del-inline-bg: #FEE2E2;
      --insight-bg: #FEFCE8; --insight-border: #FBBF24;
    }
    
    *{box-sizing:border-box}
    html,body{height:100%; margin:0; padding:0}
    body{background:var(--bg);color:var(--ink);font:14px/1.5 Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    
    .container{max-width:1400px;margin:0 auto;padding:24px}
    
    /* Header */
    .header{
      background:var(--panel);
      border-bottom:1px solid var(--line);
      padding:20px 0;
      margin-bottom:32px;
      box-shadow:var(--shadow);
    }
    
    .header-content{
      max-width:1400px;
      margin:0 auto;
      padding:0 24px;
      display:flex;
      justify-content:space-between;
      align-items:center;
    }
    
    .breadcrumb{
      display:flex;
      align-items:center;
      gap:8px;
      color:var(--muted);
      font-size:14px;
      margin-bottom:8px;
    }
    
    .breadcrumb a{
      color:var(--info);
      text-decoration:none;
    }
    
    .breadcrumb a:hover{
      text-decoration:underline;
    }
    
    .header h1{
      margin:0;
      font-size:28px;
      font-weight:700;
      color:var(--ink);
      display:flex;
      align-items:center;
      gap:12px;
    }
    
    .header-actions{
      display:flex;
      gap:12px;
      align-items:center;
    }
    
    /* Service Status Card */
    .status-card{
      background:var(--panel);
      border:1px solid var(--line);
      border-radius:12px;
      padding:24px;
      box-shadow:var(--shadow);
      margin-bottom:24px;
    }
    
    .status-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(250px, 1fr));
      gap:20px;
    }
    
    .status-item{
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    
    .status-label{
      font-size:12px;
      color:var(--muted);
      font-weight:500;
      text-transform:uppercase;
      letter-spacing:0.5px;
    }
    
    .status-value{
      font-size:16px;
      font-weight:600;
      color:var(--ink);
      display:flex;
      align-items:center;
      gap:8px;
    }
    
    .status-badge{
      padding:4px 12px;
      border-radius:20px;
      font-size:12px;
      font-weight:600;
      text-transform:uppercase;
      letter-spacing:0.5px;
    }
    
    .status-badge.certified{
      background:var(--success-bg);
      color:var(--success);
    }
    
    .status-badge.pending{
      background:var(--warning-bg);
      color:var(--warning);
    }
    
    /* Actions */
    .actions-section{
      margin-bottom:32px;
    }
    
    .actions-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));
      gap:16px;
    }
    
    .btn{
      border:1px solid var(--line);
      background:var(--panel);
      color:var(--ink);
      padding:12px 24px;
      border-radius:8px;
      cursor:pointer;
      font-size:14px;
      font-weight:600;
      text-decoration:none;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      transition:all 0.2s;
      text-align:center;
    }
    
    .btn:hover{
      background:var(--chip);
      border-color:var(--muted);
    }
    
    .btn.primary{
      background:var(--ink);
      color:white;
      border-color:var(--ink);
    }
    
    .btn.primary:hover{
      background:var(--muted);
      border-color:var(--muted);
    }
    
    .btn.success{
      background:var(--success);
      color:white;
      border-color:var(--success);
    }
    
    .btn.success:hover{
      background:#059669;
    }
    
    .btn.warning{
      background:var(--warning);
      color:white;
      border-color:var(--warning);
    }
    
    .btn.warning:hover{
      background:#D97706;
    }
    
    .btn:disabled{
      background:var(--chip);
      color:var(--muted);
      border-color:var(--line);
      cursor:not-allowed;
    }
    
    /* Results Section */
    .results-section{
      margin-bottom:32px;
    }
    
    .section-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:20px;
    }
    
    .section-title{
      font-size:20px;
      font-weight:600;
      color:var(--ink);
      margin:0;
    }
    
    .card{
      background:var(--panel);
      border:1px solid var(--line);
      border-radius:12px;
      padding:24px;
      box-shadow:var(--shadow);
      margin-bottom:20px;
    }
    
    /* Analysis Results */
    .analysis-results{
      background:var(--panel);
      border:1px solid var(--line);
      border-radius:12px;
      padding:24px;
      box-shadow:var(--shadow);
      margin-bottom:20px;
    }
    
    .result-summary{
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));
      gap:16px;
      margin-bottom:24px;
    }
    
    .result-item{
      display:flex;
      flex-direction:column;
      gap:8px;
      padding:16px;
      background:var(--chip);
      border-radius:8px;
    }
    
    .result-label{
      font-size:12px;
      color:var(--muted);
      font-weight:500;
      text-transform:uppercase;
      letter-spacing:0.5px;
    }
    
    .result-value{
      font-size:18px;
      font-weight:700;
      color:var(--ink);
    }
    
    .result-value.success{color:var(--success)}
    .result-value.warning{color:var(--warning)}
    .result-value.error{color:var(--error)}
    
    /* JSON Display */
    .json-display{
      background:#1e1e1e;
      color:#d4d4d4;
      padding:20px;
      border-radius:8px;
      font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size:13px;
      line-height:1.5;
      overflow-x:auto;
      margin-top:16px;
    }
    
    /* Loading States */
    .loading{
      display:flex;
      align-items:center;
      justify-content:center;
      padding:40px;
      color:var(--muted);
    }
    
    .spinner{
      width:20px;
      height:20px;
      border:2px solid var(--line);
      border-top:2px solid var(--info);
      border-radius:50%;
      animation:spin 1s linear infinite;
      margin-right:12px;
    }
    
    @keyframes spin{
      0%{transform:rotate(0deg)}
      100%{transform:rotate(360deg)}
    }
    
    /* Error States */
    .error-message{
      background:var(--error-bg);
      color:var(--error);
      padding:16px;
      border-radius:8px;
      border:1px solid var(--error);
      margin:20px 0;
    }

    /* Enhanced Results Styling */
    .enhanced-results {
      margin-top: 20px;
    }

    .section-title {
      font-size: 18px;
      font-weight: 600;
      color: #333;
      margin: 20px 0 15px 0;
      border-bottom: 2px solid #007bff;
      padding-bottom: 8px;
    }

    .status-overview {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin: 20px 0;
    }

    .status-item-large {
      text-align: center;
      padding: 20px;
      border-radius: 12px;
      background: #f8f9fa;
      border: 2px solid #e9ecef;
    }

    .status-label {
      font-size: 14px;
      color: #666;
      margin-bottom: 8px;
      font-weight: 500;
    }

    .status-value-large {
      font-size: 24px;
      font-weight: 700;
      text-transform: uppercase;
    }

    .status-value-large.success {
      color: #28a745;
    }

    .status-value-large.error {
      color: #dc3545;
    }

    .status-value-large.risk-high {
      color: #dc3545;
    }

    .status-value-large.risk-medium {
      color: #fd7e14;
    }

    .status-value-large.risk-low {
      color: #28a745;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin: 20px 0;
    }

    .stat-card {
      background: white;
      border: 1px solid #e9ecef;
      border-radius: 8px;
      padding: 20px;
      text-align: center;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .stat-number {
      font-size: 32px;
      font-weight: 700;
      color: #007bff;
      margin-bottom: 5px;
    }

    .stat-label {
      font-size: 14px;
      color: #666;
      font-weight: 500;
    }

    /* Policy Violations */
    .violations-section {
      margin: 30px 0;
    }

    .violations-list {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .violation-item {
      background: white;
      border: 1px solid #e9ecef;
      border-radius: 8px;
      padding: 20px;
      display: flex;
      gap: 15px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .violation-severity {
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      white-space: nowrap;
      height: fit-content;
    }

    .violation-severity.severity-critical {
      background: #dc3545;
      color: white;
    }

    .violation-severity.severity-high {
      background: #fd7e14;
      color: white;
    }

    .violation-severity.severity-medium {
      background: #ffc107;
      color: #212529;
    }

    .violation-severity.severity-low {
      background: #28a745;
      color: white;
    }

    .violation-content {
      flex: 1;
    }

    .violation-title {
      font-size: 16px;
      font-weight: 600;
      color: #333;
      margin-bottom: 8px;
    }

    .violation-description {
      color: #666;
      margin-bottom: 10px;
      line-height: 1.5;
    }

    .violation-recommendation {
      background: #e7f3ff;
      border-left: 4px solid #007bff;
      padding: 10px 15px;
      border-radius: 4px;
      color: #0056b3;
      font-size: 14px;
    }

    /* Deltas Section */
    .deltas-section {
      margin: 30px 0;
    }

    .deltas-list {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .delta-item {
      background: white;
      border: 1px solid #e9ecef;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .delta-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 1px solid #e9ecef;
    }

    .delta-file {
      font-size: 16px;
      font-weight: 600;
      color: #333;
      font-family: 'Courier New', monospace;
    }

    .delta-risk {
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
    }

    .delta-risk.risk-high {
      background: #dc3545;
      color: white;
    }

    .delta-risk.risk-medium {
      background: #fd7e14;
      color: white;
    }

    .delta-risk.risk-low {
      background: #28a745;
      color: white;
    }

    .delta-content {
      color: #666;
      line-height: 1.6;
    }

    .delta-verdict {
      margin-bottom: 10px;
    }

    .delta-violations {
      margin-bottom: 10px;
      color: #dc3545;
    }

    .delta-recommendations {
      color: #0056b3;
    }

    /* Recommendations Section */
    .recommendations-section {
      margin: 30px 0;
    }

    .recommendations-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .recommendation-item {
      background: #e7f3ff;
      border-left: 4px solid #007bff;
      padding: 15px;
      border-radius: 4px;
      display: flex;
      align-items: flex-start;
      gap: 10px;
    }

    .recommendation-icon {
      color: #007bff;
      font-weight: 700;
      font-size: 18px;
    }

    .recommendation-text {
      flex: 1;
      color: #0056b3;
      line-height: 1.5;
    }

    /* File Stats Section */
    .file-stats-section {
      margin: 30px 0;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      .status-overview {
        grid-template-columns: 1fr;
      }
      
      .stats-grid {
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      }
      
      .violation-item {
        flex-direction: column;
      }
      
      .delta-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
      }
    }
    
    /* Success States */
    .success-message{
      background:var(--success-bg);
      color:var(--success);
      padding:16px;
      border-radius:8px;
      border:1px solid var(--success);
      margin:20px 0;
    }
    
    /* Responsive */
    @media (max-width: 768px) {
      .container{padding:16px}
      .header-content{padding:0 16px}
      .status-grid{grid-template-columns:1fr}
      .actions-grid{grid-template-columns:1fr}
      .result-summary{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
  <!-- Header -->
  <div class="header">
    <div class="header-content">
      <div>
        <div class="breadcrumb">
          <a href="/">üè¢ Services Overview</a>
          <span>></span>
          <span>{{ service_name }}</span>
        </div>
        <h1>{{ service_name }}</h1>
      </div>
      <div class="header-actions">
        <button class="btn" onclick="refreshData()">
          üîÑ Refresh
        </button>
        <button class="btn primary" onclick="runAnalysis()">
          üîç Analyze Service
        </button>
      </div>
    </div>
  </div>

  <div class="container">
    <!-- Service Status -->
    <div class="status-card">
      <div class="status-grid">
        <div class="status-item">
          <div class="status-label">Current Branch</div>
          <div class="status-value">
            üåø <span id="currentBranch">{{ service_config.golden_branch }}</span>
          </div>
        </div>
        
        <div class="status-item">
          <div class="status-label">Drift Branch</div>
          <div class="status-value">
            üîÄ <span id="driftBranch">{{ service_config.drift_branch }}</span>
          </div>
        </div>
        
        <div class="status-item">
          <div class="status-label">Environment</div>
          <div class="status-value">
            <span class="status-badge certified">Production</span>
          </div>
        </div>
        
        <div class="status-item">
          <div class="status-label">Last Analysis</div>
          <div class="status-value" id="lastAnalysis">
            {% if last_result %}
              {{ last_result.timestamp }}
            {% else %}
              Never
            {% endif %}
          </div>
        </div>
      </div>
    </div>

    <!-- Quick Actions -->
    <div class="actions-section">
      <h2 class="section-title">Quick Actions</h2>
      <div class="actions-grid">
        <button class="btn primary" onclick="runAnalysis()" id="analyzeBtn">
          üîç Run Analysis
        </button>
        <button class="btn" onclick="viewHistory()">
          üìä View History
        </button>
        <button class="btn" onclick="viewConfig()">
          ‚öôÔ∏è View Config
        </button>
        <button class="btn" onclick="exportResults()">
          üì• Export Results
        </button>
      </div>
    </div>

    <!-- Analysis Results -->
    <div class="results-section">
      <div class="section-header">
        <h2 class="section-title">Analysis Results</h2>
        <div class="btn" onclick="refreshResults()">
          üîÑ Refresh Results
        </div>
      </div>
      
      <div id="resultsContainer">
        {% if last_result %}
          <div class="analysis-results">
            <!-- Validation Summary -->
            <div class="result-summary">
              <div class="result-item">
                <div class="result-label">Status</div>
                <div class="result-value success">Complete</div>
              </div>
              <div class="result-item">
                <div class="result-label">Execution Time</div>
                <div class="result-value">{{ last_result.execution_time_seconds }}s</div>
              </div>
              <div class="result-item">
                <div class="result-label">Architecture</div>
                <div class="result-value">{{ last_result.architecture }}</div>
              </div>
            </div>
            
            <!-- Enhanced Results Display -->
            {% set result_data = last_result.validation_result if last_result.validation_result else last_result %}
            <div class="enhanced-results">
              <h3 class="section-title">üìä Analysis Summary</h3>
              
              <!-- Overall Status -->
              <div class="status-overview">
                <div class="status-item-large">
                  <div class="status-label">Overall Verdict</div>
                  <div class="status-value-large {{ 'error' if result_data.verdict == 'FAIL' else 'success' }}">
                    {{ result_data.verdict or 'COMPLETED' }}
                  </div>
                </div>
                <div class="status-item-large">
                  <div class="status-label">Risk Level</div>
                  <div class="status-value-large risk-{{ result_data.overall_risk_level or 'unknown' }}">
                    {{ (result_data.overall_risk_level or 'UNKNOWN').upper() }}
                  </div>
                </div>
              </div>
                
                <!-- Statistics -->
                <div class="stats-grid">
                  <div class="stat-card">
                    <div class="stat-number">{{ result_data.total_clusters or 0 }}</div>
                    <div class="stat-label">Total Clusters</div>
                  </div>
                  <div class="stat-card">
                    <div class="stat-number">{{ result_data.policy_violations_count or result_data.policy_violations|length or 0 }}</div>
                    <div class="stat-label">Policy Violations</div>
                  </div>
                  <div class="stat-card">
                    <div class="stat-number">{{ result_data.critical_violations or 0 }}</div>
                    <div class="stat-label">Critical Issues</div>
                  </div>
                  <div class="stat-card">
                    <div class="stat-number">{{ result_data.high_violations or 0 }}</div>
                    <div class="stat-label">High Risk Issues</div>
                  </div>
                </div>
                
                <!-- Policy Violations -->
                {% if result_data.policy_violations %}
                <div class="violations-section">
                  <h3 class="section-title">‚ö†Ô∏è Policy Violations</h3>
                  <div class="violations-list">
                    {% for violation in result_data.policy_violations %}
                    <div class="violation-item">
                      <div class="violation-severity severity-{{ violation.severity or 'medium' }}">
                        {{ (violation.severity or 'MEDIUM').upper() }}
                      </div>
                      <div class="violation-content">
                        <div class="violation-title">{{ violation.title or violation.type or 'Policy Violation' }}</div>
                        <div class="violation-description">{{ violation.description or violation.message or violation }}</div>
                        {% if violation.recommendation %}
                        <div class="violation-recommendation">
                          <strong>Recommendation:</strong> {{ violation.recommendation }}
                        </div>
                        {% endif %}
                      </div>
                    </div>
                    {% endfor %}
                  </div>
                </div>
                {% endif %}
                
                <!-- Analyzed Deltas -->
                {% if result_data.analyzed_deltas %}
                <div class="deltas-section">
                  <h3 class="section-title">üìÅ File Changes Analysis</h3>
                  <div class="deltas-list">
                    {% for delta in result_data.analyzed_deltas %}
                    <div class="delta-item">
                      <div class="delta-header">
                        <div class="delta-file">{{ delta.file }}</div>
                        <div class="delta-risk risk-{{ delta.risk_level or 'low' }}">
                          {{ (delta.risk_level or 'LOW').upper() }}
                        </div>
                      </div>
                      <div class="delta-content">
                        <div class="delta-verdict">
                          <strong>Verdict:</strong> {{ delta.verdict or 'N/A' }}
                        </div>
                        {% if delta.policy_violations %}
                        <div class="delta-violations">
                          <strong>Policy Violations:</strong> {{ delta.policy_violations | join(', ') }}
                        </div>
                        {% endif %}
                        {% if delta.recommendations %}
                        <div class="delta-recommendations">
                          <strong>Recommendations:</strong> {{ delta.recommendations | join(', ') }}
                        </div>
                        {% endif %}
                      </div>
                    </div>
                    {% endfor %}
                  </div>
                </div>
                {% endif %}
                
                <!-- File Analysis Details (if available) -->
                {% if result_data.files_analyzed %}
                <div class="file-stats-section">
                  <h3 class="section-title">üìÑ File Statistics</h3>
                  <div class="stats-grid">
                    <div class="stat-card">
                      <div class="stat-number">{{ result_data.files_analyzed or 0 }}</div>
                      <div class="stat-label">Files Analyzed</div>
                    </div>
                    <div class="stat-card">
                      <div class="stat-number">{{ result_data.files_with_drift or 0 }}</div>
                      <div class="stat-label">Files with Drift</div>
                    </div>
                    <div class="stat-card">
                      <div class="stat-number">{{ result_data.total_deltas or 0 }}</div>
                      <div class="stat-label">Total Deltas</div>
                    </div>
                    <div class="stat-card">
                      <div class="stat-number">{{ result_data.deltas_analyzed or 0 }}</div>
                      <div class="stat-label">Deltas Analyzed</div>
                    </div>
                  </div>
                </div>
                {% endif %}
                
                <!-- Recommendations (if available) -->
                {% if result_data.recommendations %}
                <div class="recommendations-section">
                  <h3 class="section-title">üí° Recommendations</h3>
                  <div class="recommendations-list">
                    {% for recommendation in result_data.recommendations %}
                    <div class="recommendation-item">
                      <span class="recommendation-icon">‚úì</span>
                      <span class="recommendation-text">{{ recommendation }}</span>
                    </div>
                    {% endfor %}
                  </div>
                </div>
                {% endif %}
                
                <!-- Debug: Show raw JSON in collapsed section (only for debugging) -->
                <details style="margin-top: 30px;">
                  <summary style="cursor: pointer; color: #666; font-size: 14px; padding: 10px; background: #f8f9fa; border-radius: 4px;">
                    üîç View Raw JSON (For Debugging)
                  </summary>
                  <div class="json-display" style="margin-top: 10px;">
                    <pre>{{ result_data | tojson(indent=2) }}</pre>
                  </div>
                </details>
              </div>
          </div>
        {% else %}
          <div class="card">
            <div class="loading">
              <div class="spinner"></div>
              No analysis results yet. Click "Run Analysis" to start.
            </div>
          </div>
        {% endif %}
      </div>
    </div>
  </div>

  <script>
    const serviceId = '{{ service_id }}';
    let isAnalyzing = false;
    
    // Run analysis
    async function runAnalysis() {
      if (isAnalyzing) return;
      
      try {
        isAnalyzing = true;
        const button = document.getElementById('analyzeBtn');
        const originalText = button.innerHTML;
        
        button.innerHTML = 'üîÑ Analyzing...';
        button.disabled = true;
        
        // Show loading in results
        document.getElementById('resultsContainer').innerHTML = `
          <div class="card">
            <div class="loading">
              <div class="spinner"></div>
              Running multi-agent analysis... This may take 1-2 minutes.
            </div>
          </div>
        `;
        
        const response = await fetch(`/api/services/${serviceId}/analyze`, {
          method: 'POST'
        });
        
        if (!response.ok) {
          throw new Error('Analysis failed');
        }
        
        const result = await response.json();
        
        // Show success message and reload to display formatted results
        document.getElementById('resultsContainer').innerHTML = `
          <div class="success-message">
            ‚úÖ Analysis completed successfully! Refreshing to show formatted results...
          </div>
        `;
        
        button.innerHTML = '‚úÖ Complete';
        
        // Reload page after 1 second to show formatted results
        setTimeout(() => {
          window.location.reload();
        }, 1000);
        
      } catch (error) {
        console.error('Analysis error:', error);
        
        document.getElementById('resultsContainer').innerHTML = `
          <div class="error-message">
            ‚ùå Analysis failed: ${error.message}
          </div>
        `;
        
        document.getElementById('analyzeBtn').innerHTML = '‚ùå Failed';
        setTimeout(() => {
          document.getElementById('analyzeBtn').innerHTML = 'üîç Run Analysis';
          document.getElementById('analyzeBtn').disabled = false;
          isAnalyzing = false;
        }, 3000);
      }
    }
    
    // Refresh data
    function refreshData() {
      window.location.reload();
    }
    
    // Refresh results
    function refreshResults() {
      refreshData();
    }
    
    // View history
    function viewHistory() {
      alert('History feature coming soon! This will show previous analysis results.');
    }
    
    // View config
    function viewConfig() {
      const config = {{ service_config | tojson | safe }};
      const configWindow = window.open('', '_blank', 'width=800,height=600');
      configWindow.document.write(`
        <html>
          <head><title>Service Configuration</title></head>
          <body style="font-family: monospace; padding: 20px; background: #f5f5f5;">
            <h2>Service Configuration: ${config.name}</h2>
            <pre style="background: white; padding: 20px; border-radius: 8px; border: 1px solid #ddd;">
${JSON.stringify(config, null, 2)}
            </pre>
          </body>
        </html>
      `);
    }
    
    // Export results
    function exportResults() {
      const results = {{ last_result | tojson | safe if last_result else 'null' }};
      if (!results) {
        alert('No results to export. Run an analysis first.');
        return;
      }
      
      const dataStr = JSON.stringify(results, null, 2);
      const dataBlob = new Blob([dataStr], {type: 'application/json'});
      const url = URL.createObjectURL(dataBlob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `${serviceId}_analysis_${new Date().toISOString().split('T')[0]}.json`;
      link.click();
      URL.revokeObjectURL(url);
    }
    
    // Auto-refresh every 30 seconds if no analysis is running
    setInterval(() => {
      if (!isAnalyzing) {
        // You could add auto-refresh logic here if needed
      }
    }, 30000);
  </script>
</body>
</html>
